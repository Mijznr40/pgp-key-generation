#!/usr/bin/env bash
set -euo pipefail

[[ $# -ne 1 ]] && {
    echo >&2 "Usage: ./fail_reproduction.sh <working directory>"
    exit 1
}
workdir="$1"
mkdir -p "$workdir" && cd "$workdir"

base64 -d >failing_key <<EOF
lQOWBCYDdYQBCADIVCM7AuYOrJLsVhfUaPITA2T27XDAM2S00VaR4T5WmeN1dMPU/ADWUpU5Y2u5
97rjRK90D3ytjxyOL9hYoQr+dBR4d6DKrBIPmfrqhevmLzcBO/n6DIoujYTYN4d1tAwF9aLUzn7A
o9h+CNa8/7qZmRqKtuq9TS/p/PLJ5Ul/2zxpBuoNZ1bgHxjQFRu+3Q+CiVaWXORtwaZ7t3y1g/OI
+MXsTfLKeONruWRZDKJpjJt26bA+wysVaZDkSe9GS7/Wd4gMWFD1kE+7rgF4sDGyWdLDHFgVA0K9
vA/VlZxAXVDekp3TS4IN0rO0t6NEMSFJqkZywA4kh+ZOR6mERH9PAAURAAf/RrRIq2pvUHkky+Im
hzQZM+MUk2LcgBIjixy1JG2dh/oUC1ZjPBy1AFlh2AT42DlRBOsQv4z+09goMi8BEDjWtCj4KoST
GlrZMq7RB3qPfmsEWsnfwaoSpwTFeX0CogNPiaH9PAylNO6IpPQPjf/ngYFUqW28Qs/yyw37VlDs
w7YqGPVuCEaaHDtmEO658LxhpiZhueKSPHUyXG56oRayPQFdPpySACPcxfwoOU6yvqWUyqKTLOw8
ARQv9Sb20XYJlzyiGFFS/tzZ3vPRNl8kUHz7XZA0TWZHO5dWC5hDIlC6NgjKSPWD+FIcS+TpmgG8
Hiu7espxaOOTZfd5ndbuAQQA25rNyVM1LGvZ7h1TqxBKz75pnFZUnKLvKno+VagkGWO5i7kB4YiP
LsoT65uLZbwh5sVxeHIlMlSAJH9K7/H0hMW41uT4Q5NuZ7SrCSDI56nPO4ZLsZZrBmyFw33/0b1O
U6+KWBn6WMYjma+7q2x/r4u9+zolQRtYNVhTeo9CAt0EAOmHgb5NaiB5nN7YHQyEfIBtXaVcBlQf
hm1Q6suaSjZ4ZgdXOx5BhBhwsFwbIkI76uRzVkF4AKQTMDnZEJlYM3U5kuXieaI6sClkpXzohGMk
fc8JDWejS8fTCYM2u7b3KkLrRLM/7t4IG8nYngyjVzITGw1csou1VY9VDFZgdtobBADMl46IcGgr
VUdZMkH1kXGHBNkwuC9D7ndNf6vAbQTn4HB7Wi2y55AG/TkPTKcmy6ddUFYqCGWE1B50DXH9vrAa
x5Tthxnm7Df/pBzOVnI9aRFmmate+puxiYVHFz/WqtcRwLmPJnpwUi5dEJ6C9lmwS4rJeVyaHZrB
gQNnTJxbnjA/tQEvaExlVV44LzRlcXJVVFw8RUNiYU55cUdiLX51RkN8Y1EgeytiPD5OfEZJOX07
dGklbUVlRVR6NEtXW21mZV8hIHAsaXldXnh1cSBfXkNTMEl9LmlnVkw3L35pfXI1W0piX3dRZ3lI
RzFlcSA8dWMobGFsNm9cSnMxY3kqM1B7OENiP3xgRXwtOXdlJz1jNSF0VzlnIT1yKjBvdmd4Uz8q
ZUdLKX11Z2ZxYkVoNXs2YTtSe1cseCh9e1h5IUI7IW1XJGlIYz1xOzh0YUhEXjg/YDQ6NCRrcT50
QH5zS20kbDgpTTBDNUx+RlhAbSNeOlJMQGxUbVEnaH4zKid2JG0hYllLay82WCg5LzQhbz5aTko1
UyhlSl0jPD9YTkIoc1wnVic/MDwqZEBLL3RYcVw+iQE8BBMBCAAmBQJaTDaWBQlOoZokFiEEyHY/
bKUs3TY9VvpHyZ/XzIFBC58CGwEACgkQyZ/XzIFBC58qLQgAhPVM3jMrFJNcDQw9ZDQ6qzhQT1eV
rI1guFAJ9rWVujduyKAfQZmyCw0BEAzDpGefjBg5YP8G5ImubAw5YT43OhB2rfrVPDbUgdWDuqGY
KWRO/wEJ53BdDW+c551cF8xFdpPJvD/VLYhs7EPZfEkWDArdZEur70LQCnuPxoUwr1IHv7HHnCSh
RySUoSo2zlrm+o9IMydWOAeG8l2Pt3ZNA5kzRD2ipGVZaHMOG00u8YQ8l9PFC87H2UfqGXT6LZ5+
mLsYXVfUwnUOK4IaaKXR3wP0hVPZ/sUMXrDt0FXQ+ONSSfoNMvBKGZDDEui/b5oiWFzotxhEZcXF
mQ/vY7Bx1J0DlgQmA3WEAQgA4LNt1YIlf9AyGomQpeGgAjyg9gkzrZxmOtiNU7CiSJhPhdv5DLrY
wkR0SbcVZDkPV8nI327uigYGi/r8CuHSXzD3ZGoggFFtCjszN13kfcHcUZiWwnTTvijN8ClWD3gG
trP9x617bufEJr8+YqSF8OpYuOUtsIWOAc5PwXVlJdhQqpgx+WNXibdLKgPhBXhphUq8nW5f2Cd5
B6etptrNxVO79Uy2q3SnbiraZfQLXxLPoppRPe8M/sx2etLDstrs7BbvLN1l9t5EGf62MDsZmn/w
s8axPhz1EaHeNyOV2aOk/Lo3zjpWnwiEGIf52HoKXI8wrYMSA7pXsC4hLxkbPwAFEQAH/RPTmMAD
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
EOF

exec 5>&1

function yep_test_failed() {
    echo >&5 "The test failed as expected; inspect $workdir/out.log for logs"
    exit 0
}

[[ -d gpg-homedir ]] && rm -rf gpg-homedir
[[ -f out ]] && rm out
[[ -f decr ]] && rm decr

for i in $(seq 1 200); do
    echo
    mkdir gpg-homedir
    chmod go-rwx gpg-homedir
    gpg --homedir gpg-homedir --import failing_key || yep_test_failed
    gpg --homedir gpg-homedir --sign --encrypt --trusted-key C99FD7CC81410B9F \
            --local-user C99FD7CC81410B9F -r C99FD7CC81410B9F \
            -o out <(echo text) || yep_test_failed
    gpg --homedir gpg-homedir --decrypt -o decr out || yep_test_failed
    rm -rf gpg-homedir decr out
done >out.log 2>&1
